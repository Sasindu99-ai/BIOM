{% extends 'admin_base.html' %}
{% load static %}
{% load files %}
{% load util %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Main Content Card -->
            <div class="card">
                <div class="card-header"
                    style="background-color: var(--card-header-bg, #0b1220); border-bottom: 1px solid var(--card-border, #374151); color: var(--text-primary, #e5e7eb);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="dataset-header-icon">
                                <i class="bi bi-database-fill"></i>
                            </div>
                            <div>
                                <h3 class="mb-0 fw-bold" id="datasetName">Loading...</h3>
                                <p class="text-muted mb-0 small" id="datasetMeta"></p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            {% if canEdit %}
                            <a href="/dashboard/datasets/import/{{ datasetId }}" class="btn btn-outline-success"
                                title="Import Data">
                                <i class="bi bi-upload me-1"></i> Import
                            </a>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="openEditModal()">
                                    <i class="bi bi-pencil me-1"></i> Edit
                                </button>
                                <a href="/dashboard/datasets/edit/{{ datasetId }}" target="_blank"
                                    class="btn btn-outline-primary" title="Edit in fullscreen">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </div>
                            {% endif %}
                            <a href="{% url 'dashboard/datasets' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i> Back
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="dataset-tabs"
                    style="background-color: var(--bg-tertiary, #071025); border-bottom: 1px solid var(--border-secondary, #1f2937);">
                    <ul class="nav nav-tabs border-0" id="datasetTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                                data-bs-target="#overview-panel" type="button" role="tab">
                                <i class="bi bi-info-circle me-1"></i> Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="variables-tab" data-bs-toggle="tab"
                                data-bs-target="#variables-panel" type="button" role="tab">
                                <i class="bi bi-list-ul me-1"></i> Variables
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="patients-tab" data-bs-toggle="tab"
                                data-bs-target="#patients-panel" type="button" role="tab">
                                <i class="bi bi-people me-1"></i> Patients
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-panel"
                                type="button" role="tab">
                                <i class="bi bi-table me-1"></i> Data
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab"
                                data-bs-target="#history-panel" type="button" role="tab">
                                <i class="bi bi-clock-history me-1"></i> History
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="card-body" style="color: var(--text-primary, #e5e7eb);">
                    <div class="tab-content" id="datasetTabContent">

                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview-panel" role="tabpanel">
                            <div id="overviewContent">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-3 text-muted">Loading dataset details...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Variables Tab -->
                        <div class="tab-pane fade" id="variables-panel" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Dataset Variables</h5>
                                {% if canEdit %}
                                <button class="btn btn-success" id="addVariableBtn">
                                    <i class="bi bi-plus-lg me-1"></i> Add Variable
                                </button>
                                {% endif %}
                            </div>
                            <div id="variablesContent">
                                <div class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="ms-2">Loading variables...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Patients Tab -->
                        <div class="tab-pane fade" id="patients-panel" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Patients in Dataset</h5>
                                <div class="d-flex gap-2 align-items-center">
                                    <span class="badge bg-primary" id="patientsTotalBadge">0 patients</span>
                                </div>
                            </div>
                            <div id="patientsContent">
                                <div class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="ms-2">Loading patients...</span>
                                </div>
                            </div>
                            <div id="patientsPagination" class="d-flex justify-content-between align-items-center mt-3"
                                style="display: none !important;">
                                <span class="text-muted small" id="patientsPageInfo"></span>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary" id="patientsPrevBtn">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="patientsNextBtn">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Data Tab -->
                        <div class="tab-pane fade" id="data-panel" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Data Preview</h5>
                                <div class="d-flex gap-2 align-items-center">
                                    <label class="small text-muted mb-0">Rows:</label>
                                    <select id="dataPageSize" class="form-select form-select-sm"
                                        style="width: auto; background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                            </div>
                            <div id="dataContent">
                                <div class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="ms-2">Loading data...</span>
                                </div>
                            </div>
                            <div id="dataPagination" class="d-flex justify-content-between align-items-center mt-3"
                                style="display: none !important;">
                                <span class="text-muted small" id="dataPageInfo"></span>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary" id="dataPrevBtn">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="dataNextBtn">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div class="tab-pane fade" id="history-panel" role="tabpanel">
                            <h5 class="mb-3">Update History</h5>
                            <div id="historyContent">
                                <div class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="ms-2">Loading history...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Variable Modal -->
<div class="modal fade" id="variableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content"
            style="background-color: var(--card-bg, #111827); border: 1px solid var(--card-border, #374151);">
            <div class="modal-header"
                style="background-color: var(--card-header-bg, #0b1220); border-bottom: 1px solid var(--card-border, #374151);">
                <h5 class="modal-title" style="color: var(--text-primary, #e5e7eb);">
                    <i class="bi bi-plus-circle me-2"></i><span id="variableModalTitle">Add Variable</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="color: var(--text-primary, #e5e7eb);">
                <form id="variableForm">
                    <input type="hidden" id="editVariableId">
                    <div class="mb-3">
                        <label class="form-label">Variable Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="variableName" required
                            style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="variableType"
                                style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);">
                                {% for val, label in variableTypes %}
                                <option value="{{ val }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Field</label>
                            <select class="form-select" id="variableField"
                                style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);">
                                {% for val, label in variableFields %}
                                <option value="{{ val }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="variableNotes" rows="2"
                            style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="variableIsSearchable">
                                <label class="form-check-label" for="variableIsSearchable">Searchable</label>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="variableIsUnique">
                                <label class="form-check-label" for="variableIsUnique">Unique</label>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="variableIsRange">
                                <label class="form-check-label" for="variableIsRange">Range</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"
                style="background-color: var(--card-header-bg, #0b1220); border-top: 1px solid var(--card-border, #374151);">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveVariableBtn">
                    <i class="bi bi-check-lg me-1"></i> Save Variable
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Dataset Modal -->
<div class="modal fade" id="editDatasetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content"
            style="background-color: var(--card-bg, #111827); border: 1px solid var(--card-border, #374151);">
            <div class="modal-header"
                style="background-color: var(--card-header-bg, #0b1220); border-bottom: 1px solid var(--card-border, #374151);">
                <div class="d-flex align-items-center gap-3">
                    <div class="dataset-header-icon"
                        style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);">
                        <i class="bi bi-pencil-square"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" style="color: var(--text-primary, #e5e7eb);">Edit Dataset</h5>
                        <p class="text-muted mb-0 small">Update dataset information</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="color: var(--text-primary, #e5e7eb);" id="editDatasetModalContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">Loading form...</p>
                </div>
            </div>
            <div class="modal-footer"
                style="background-color: var(--card-header-bg, #0b1220); border-top: 1px solid var(--card-border, #374151);">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="updateDataset()">
                    <i class="bi bi-check-lg me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block css %}
{{ block.super }}
<style>
    .dataset-header-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
    }

    .dataset-tabs .nav-link {
        color: #9ca3af;
        background: transparent;
        border: none;
        padding: 0.75rem 1.25rem;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
    }

    .dataset-tabs .nav-link:hover {
        color: #e5e7eb;
        background-color: rgba(59, 130, 246, 0.1);
    }

    .dataset-tabs .nav-link.active {
        color: #3b82f6;
        background: transparent;
        border-bottom-color: #3b82f6;
    }

    /* Overview Stats */
    .overview-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .overview-stat-card {
        padding: 1rem;
        background-color: #1e1e2e;
        border: 1px solid #2a2a3a;
        border-radius: 8px;
        text-align: center;
    }

    .overview-stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #f4f4f5;
    }

    .overview-stat-label {
        font-size: 0.8rem;
        color: #71717a;
    }

    .overview-info-row {
        display: flex;
        padding: 0.75rem 0;
        border-bottom: 1px solid #2a2a3a;
    }

    .overview-info-label {
        width: 140px;
        font-weight: 500;
        color: #71717a;
        flex-shrink: 0;
    }

    .overview-info-value {
        flex: 1;
        color: #e4e4e7;
    }

    /* Variable List */
    .variable-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        background-color: #1e1e2e;
        border: 1px solid #2a2a3a;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }

    .variable-item:hover {
        border-color: #3b82f6;
        background-color: #252535;
    }

    .variable-name {
        font-weight: 500;
        color: #f4f4f5;
        flex: 1;
    }

    .variable-type-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .type-text {
        background-color: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }

    .type-number {
        background-color: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .type-date {
        background-color: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .type-boolean {
        background-color: rgba(139, 92, 246, 0.15);
        color: #8b5cf6;
    }

    .variable-field-badge {
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-size: 0.65rem;
        background-color: rgba(113, 113, 122, 0.2);
        color: #a1a1aa;
    }

    .variable-flags {
        display: flex;
        gap: 0.5rem;
    }

    .variable-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Data Table */
    .data-table-wrapper {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }

    .data-table th {
        background-color: #1e1e2e;
        color: #a1a1aa;
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 500;
        border-bottom: 1px solid #2a2a3a;
        white-space: nowrap;
    }

    .data-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #2a2a3a;
        color: #e4e4e7;
    }

    .data-table tr:hover td {
        background-color: #252535;
    }

    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #2a2a3a;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.75rem;
        top: 0.25rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #3b82f6;
        border: 2px solid #1e1e2e;
    }

    .timeline-item.event-created::before {
        background-color: #10b981;
    }

    .timeline-item.event-updated::before {
        background-color: #f59e0b;
    }

    .timeline-item.event-data_added::before {
        background-color: #3b82f6;
    }

    .timeline-time {
        font-size: 0.75rem;
        color: #71717a;
        margin-bottom: 0.25rem;
    }

    .timeline-content {
        color: #e4e4e7;
    }

    .timeline-user {
        font-size: 0.8rem;
        color: #a1a1aa;
        margin-top: 0.25rem;
    }

    /* Badges */
    .badge-active {
        background-color: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .badge-inactive {
        background-color: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    /* Patient Avatar */
    .patient-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block js %}
<script nonce="{{ nonce }}">
    const datasetId = {{ datasetId }};
    let currentVariables = [];
    let currentDataPage = 1;
    let dataPageLimit = 10;
    let currentPatientsPage = 1;
    let patientsPageLimit = 20;

    // Utility functions
    function formatDateShort(dateString) {
        if (!dateString) return '—';
        const d = new Date(dateString);
        return d.toLocaleDateString();
    }

    function formatRelativeTime(dateString) {
        if (!dateString) return '—';
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'm ago';
        if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'h ago';
        if (diffInSeconds < 2592000) return Math.floor(diffInSeconds / 86400) + 'd ago';
        return formatDateShort(dateString);
    }

    // Load dataset details
    async function loadDatasetDetails() {
        try {
            const response = await fetch(`/api/v1/dataset/${datasetId}/details`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (!response.ok) throw new Error('Failed to load details');
            const result = await response.json();
            const data = result.data || result;

            const dataset = data.dataset[0];
            currentVariables = data.variables || [];
            const stats = data.stats || {};

            // Update header
            document.getElementById('datasetName').textContent = dataset.name || 'Dataset';
            document.getElementById('datasetMeta').textContent = `${dataset.category || 'N/A'} • v${dataset.version || 1} • ${formatRelativeTime(dataset.created_at)}`;

            // Render tabs
            renderOverviewTab(dataset, stats);
            renderVariablesTab(currentVariables);
            loadPatients();
            loadDataPreview();
            loadDatasetHistory();

        } catch (err) {
            console.error('Error loading dataset details', err);
            document.getElementById('overviewContent').innerHTML = `
				<div class="text-center py-5 text-danger">
					<i class="bi bi-exclamation-circle fs-1"></i>
					<p class="mt-3">Failed to load dataset details</p>
				</div>
			`;
        }
    }

    function renderOverviewTab(dataset, stats) {
        const html = `
			<div class="overview-stats">
				<div class="overview-stat-card">
					<div class="overview-stat-value">${stats.variablesCount || 0}</div>
					<div class="overview-stat-label">Variables</div>
				</div>
				<div class="overview-stat-card">
					<div class="overview-stat-value">${stats.userStudiesCount || 0}</div>
					<div class="overview-stat-label">Data Entries</div>
				</div>
				<div class="overview-stat-card">
					<div class="overview-stat-value">${stats.resultsCount || 0}</div>
					<div class="overview-stat-label">Total Results</div>
				</div>
				<div class="overview-stat-card">
					<div class="overview-stat-value">v${dataset.version || 1}</div>
					<div class="overview-stat-label">Version</div>
				</div>
			</div>
			
			<h5 class="mb-3">Dataset Information</h5>
			<div class="overview-info-row">
				<div class="overview-info-label">Name</div>
				<div class="overview-info-value">${dataset.name || 'N/A'}</div>
			</div>
			<div class="overview-info-row">
				<div class="overview-info-label">Category</div>
				<div class="overview-info-value">${dataset.category || 'N/A'}</div>
			</div>
			<div class="overview-info-row">
				<div class="overview-info-label">Status</div>
				<div class="overview-info-value">
					<span class="dataset-badge ${dataset.status === 'ACTIVE' ? 'badge-active' : 'badge-inactive'}" style="padding: 0.25rem 0.65rem; border-radius: 6px; font-size: 0.75rem;">
						${dataset.status || 'Active'}
					</span>
				</div>
			</div>
			<div class="overview-info-row">
				<div class="overview-info-label">Description</div>
				<div class="overview-info-value">${dataset.description || 'No description available'}</div>
			</div>
			<div class="overview-info-row">
				<div class="overview-info-label">Reference</div>
				<div class="overview-info-value">${dataset.reference || 'N/A'}</div>
			</div>
			<div class="overview-info-row">
				<div class="overview-info-label">Created</div>
				<div class="overview-info-value">${formatDateShort(dataset.created_at)}</div>
			</div>
		`;
        document.getElementById('overviewContent').innerHTML = html;
    }

    function renderVariablesTab(variables) {
        if (!variables || variables.length === 0) {
            document.getElementById('variablesContent').innerHTML = `
				<div class="text-center py-4 text-muted">
					<i class="bi bi-list-ul fs-1 opacity-50"></i>
					<p class="mt-2">No variables defined for this dataset</p>
				</div>
			`;
            return;
        }

        const html = variables.map(v => `
			<div class="variable-item" data-id="${v.id}">
				<span class="text-muted small">#${v.order || '-'}</span>
				<span class="variable-name">${v.name}</span>
				<span class="variable-type-badge type-${(v.type || 'text').toLowerCase()}">${v.type}</span>
				<span class="variable-field-badge">${v.field || 'TEXT'}</span>
				<span class="dataset-badge ${v.status === 'ACTIVE' ? 'badge-active' : 'badge-inactive'}" style="padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">${v.status}</span>
				<div class="variable-flags">
					${v.isSearchable ? '<i class="bi bi-search text-info" title="Searchable"></i>' : ''}
					${v.isUnique ? '<i class="bi bi-fingerprint text-warning" title="Unique"></i>' : ''}
					${v.isRange ? '<i class="bi bi-arrows-expand text-success" title="Range"></i>' : ''}
				</div>
				{% if canEdit %}
				<div class="variable-actions">
					<button class="btn btn-sm btn-outline-primary" onclick="editVariable(${v.id})">
						<i class="bi bi-pencil"></i>
					</button>
					<button class="btn btn-sm btn-outline-danger" onclick="deleteVariable(${v.id})">
						<i class="bi bi-trash"></i>
					</button>
				</div>
				{% endif %}
			</div>
		`).join('');

        document.getElementById('variablesContent').innerHTML = html;
    }

    async function loadDataPreview() {
        document.getElementById('dataContent').innerHTML = `
			<div class="text-center py-4">
				<div class="spinner-border text-primary spinner-border-sm" role="status"></div>
				<span class="ms-2 text-muted">Loading data...</span>
			</div>
		`;

        try {
            const response = await fetch(`/api/v1/dataset/${datasetId}/data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ page: currentDataPage, limit: dataPageLimit })
            });

            if (!response.ok) throw new Error('Failed to load data');
            const result = await response.json();
            const data = result.data || result;

            renderDataTable(data.columns || [], data.rows || []);
            updateDataPagination(data.pagination);

        } catch (err) {
            console.error('Error loading data preview', err);
            document.getElementById('dataContent').innerHTML = `
				<div class="text-center py-4 text-muted">
					<i class="bi bi-table fs-1 opacity-50"></i>
					<p class="mt-2">No data available</p>
				</div>
			`;
        }
    }

    function renderDataTable(columns, rows) {
        if (rows.length === 0) {
            document.getElementById('dataContent').innerHTML = `
				<div class="text-center py-4 text-muted">
					<i class="bi bi-table fs-1 opacity-50"></i>
					<p class="mt-2">No data entries available</p>
				</div>
			`;
            return;
        }

        let html = '<div class="data-table-wrapper"><table class="data-table"><thead><tr>';
        html += '<th>#</th><th>Patient</th><th>Reference</th><th>Status</th>';
        columns.forEach(col => {
            html += `<th>${col.name}</th>`;
        });
        html += '</tr></thead><tbody>';

        rows.forEach((row, idx) => {
            html += '<tr>';
            html += `<td>${(currentDataPage - 1) * dataPageLimit + idx + 1}</td>`;
            html += `<td>${row.patient?.name || 'N/A'}</td>`;
            html += `<td>${row.reference || '-'}</td>`;
            html += `<td><span class="dataset-badge ${row.status === 'COMPLETED' ? 'badge-active' : 'badge-inactive'}" style="padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">${row.status}</span></td>`;
            columns.forEach(col => {
                html += `<td>${row.values[col.id] || '-'}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        document.getElementById('dataContent').innerHTML = html;
    }

    function updateDataPagination(pagination) {
        if (!pagination || pagination.total === 0) {
            document.getElementById('dataPagination').style.display = 'none';
            return;
        }

        document.getElementById('dataPagination').style.display = 'flex';
        document.getElementById('dataPageInfo').textContent =
            `Showing ${(pagination.page - 1) * pagination.limit + 1}-${Math.min(pagination.page * pagination.limit, pagination.total)} of ${pagination.total}`;

        document.getElementById('dataPrevBtn').disabled = !pagination.hasPrev;
        document.getElementById('dataNextBtn').disabled = !pagination.hasNext;
    }

    async function loadDatasetHistory() {
        try {
            const response = await fetch(`/api/v1/dataset/${datasetId}/history`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (!response.ok) throw new Error('Failed to load history');
            const result = await response.json();
            const events = result.data?.events || result.events || [];

            renderHistoryTimeline(events);

        } catch (err) {
            console.error('Error loading history', err);
            document.getElementById('historyContent').innerHTML = `
				<div class="text-center py-4 text-muted">
					<i class="bi bi-clock-history fs-1 opacity-50"></i>
					<p class="mt-2">No history available</p>
				</div>
			`;
        }
    }

    // Load patients associated with this dataset
    let currentPatients = [];

    async function loadPatients() {
        document.getElementById('patientsContent').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                <span class="ms-2 text-muted">Loading patients...</span>
            </div>
        `;

        try {
            const response = await fetch(`/api/v1/dataset/${datasetId}/patients?page=${currentPatientsPage}&limit=${patientsPageLimit}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (!response.ok) throw new Error('Failed to load patients');
            const result = await response.json();
            const data = result.data || result;

            currentPatients = data.patients || [];
            const pagination = data.pagination || {};

            document.getElementById('patientsTotalBadge').textContent = `${pagination.total || 0} patients`;
            renderPatientsTable(currentPatients);
            updatePatientsPagination(pagination);

        } catch (err) {
            console.error('Error loading patients', err);
            document.getElementById('patientsContent').innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-people fs-1 opacity-50"></i>
                    <p class="mt-2">No patients found</p>
                </div>
            `;
        }
    }

    function renderPatientsTable(patients) {
        if (!patients || patients.length === 0) {
            document.getElementById('patientsContent').innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-people fs-1 opacity-50"></i>
                    <p class="mt-2">No patients in this dataset yet</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Patient</th>
                            <th>Reference</th>
                            <th>Gender</th>
                            <th>Age</th>
                            <th>Status</th>
                            <th>Data Entries</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        patients.forEach((p, idx) => {
            html += `
                <tr>
                    <td>${(currentPatientsPage - 1) * patientsPageLimit + idx + 1}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="patient-avatar">
                                <i class="bi bi-person"></i>
                            </div>
                            <div>
                                <div class="fw-medium">${p.firstName || ''} ${p.lastName || ''}</div>
                                <div class="small text-muted">ID: ${p.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>${p.reference || '-'}</td>
                    <td>${p.gender || '-'}</td>
                    <td>${p.age || '-'}</td>
                    <td>
                        <span class="dataset-badge ${p.status === 'ACTIVE' ? 'badge-active' : 'badge-inactive'}" 
                              style="padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">
                            ${p.status || 'Active'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-info">${p.dataEntriesCount || 0}</span>
                    </td>
                    <td>
                        <a href="/dashboard/patients/view/${p.id}" class="btn btn-sm btn-outline-primary" title="View Patient">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        document.getElementById('patientsContent').innerHTML = html;
    }

    function updatePatientsPagination(pagination) {
        if (!pagination || pagination.total === 0) {
            document.getElementById('patientsPagination').style.display = 'none';
            return;
        }

        document.getElementById('patientsPagination').style.display = 'flex';
        document.getElementById('patientsPageInfo').textContent =
            `Showing ${(pagination.page - 1) * pagination.limit + 1}-${Math.min(pagination.page * pagination.limit, pagination.total)} of ${pagination.total}`;

        document.getElementById('patientsPrevBtn').disabled = !pagination.hasPrev;
        document.getElementById('patientsNextBtn').disabled = !pagination.hasNext;
    }

    function renderHistoryTimeline(events) {
        if (!events || events.length === 0) {
            document.getElementById('historyContent').innerHTML = `
				<div class="text-center py-4 text-muted">
					<i class="bi bi-clock-history fs-1 opacity-50"></i>
					<p class="mt-2">No history events found</p>
				</div>
			`;
            return;
        }

        const html = '<div class="timeline">' + events.map(e => `
			<div class="timeline-item event-${e.type}">
				<div class="timeline-time">${formatRelativeTime(e.timestamp)}</div>
				<div class="timeline-content">${e.description}</div>
				<div class="timeline-user">by ${e.user?.name || 'System'}</div>
			</div>
		`).join('') + '</div>';

        document.getElementById('historyContent').innerHTML = html;
    }

    // Variable CRUD
    function showAddVariableForm() {
        document.getElementById('variableModalTitle').textContent = 'Add Variable';
        document.getElementById('editVariableId').value = '';
        document.getElementById('variableForm').reset();
        const modal = new bootstrap.Modal(document.getElementById('variableModal'));
        modal.show();
    }

    function editVariable(varId) {
        const variable = currentVariables.find(v => v.id === varId);
        if (!variable) return;

        document.getElementById('variableModalTitle').textContent = 'Edit Variable';
        document.getElementById('editVariableId').value = varId;
        document.getElementById('variableName').value = variable.name || '';
        document.getElementById('variableType').value = variable.type || 'TEXT';
        document.getElementById('variableField').value = variable.field || 'TEXT';
        document.getElementById('variableNotes').value = variable.notes || '';
        document.getElementById('variableIsSearchable').checked = variable.isSearchable;
        document.getElementById('variableIsUnique').checked = variable.isUnique;
        document.getElementById('variableIsRange').checked = variable.isRange;

        const modal = new bootstrap.Modal(document.getElementById('variableModal'));
        modal.show();
    }

    async function saveVariable() {
        const varId = document.getElementById('editVariableId').value;
        const isEdit = !!varId;

        const data = {
            name: document.getElementById('variableName').value,
            type: document.getElementById('variableType').value,
            field: document.getElementById('variableField').value,
            notes: document.getElementById('variableNotes').value,
            isSearchable: document.getElementById('variableIsSearchable').checked,
            isUnique: document.getElementById('variableIsUnique').checked,
            isRange: document.getElementById('variableIsRange').checked,
        };

        try {
            const url = isEdit ? `/api/v1/dataset/${datasetId}/variables/${varId}` : `/api/v1/dataset/${datasetId}/variables`;
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Failed to save variable');

            bootstrap.Modal.getInstance(document.getElementById('variableModal')).hide();
            loadDatasetDetails();

            onUtil(() => {
                thread(() => {
                    new UTIL.Toast().ok(isEdit ? 'Variable updated!' : 'Variable added!', 'Success', 'success');
                });
            });

        } catch (err) {
            console.error('Error saving variable', err);
            onUtil(() => {
                thread(() => {
                    new UTIL.Toast().ok('Failed to save variable', 'Error', 'error');
                });
            });
        }
    }

    async function deleteVariable(varId) {
        if (!confirm('Are you sure you want to delete this variable?')) return;

        try {
            const response = await fetch(`/api/v1/dataset/${datasetId}/variables/${varId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (!response.ok) throw new Error('Failed to delete variable');

            loadDatasetDetails();

            onUtil(() => {
                thread(() => {
                    new UTIL.Toast().ok('Variable deleted!', 'Success', 'success');
                });
            });

        } catch (err) {
            console.error('Error deleting variable', err);
            onUtil(() => {
                thread(() => {
                    new UTIL.Toast().ok('Failed to delete variable', 'Error', 'error');
                });
            });
        }
    }

    // Edit dataset popup
    async function openEditModal() {
        const modal = new bootstrap.Modal(document.getElementById('editDatasetModal'));
        modal.show();

        const contentEl = document.getElementById('editDatasetModalContent');
        contentEl.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">Loading form...</p>
            </div>
        `;

        try {
            const response = await fetch(`/dashboard/datasets/edit/${datasetId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (!response.ok) throw new Error('Failed to load form');

            const html = await response.text();
            contentEl.innerHTML = html;

        } catch (err) {
            console.error('Error loading edit form', err);
            contentEl.innerHTML = `
                <div class="text-center py-5 text-danger">
                    <i class="bi bi-exclamation-circle fs-1"></i>
                    <p class="mt-3">Failed to load form</p>
                </div>
            `;
        }
    }

    async function updateDataset() {
        const name = document.getElementById('editDatasetName').value;
        const description = document.getElementById('editDatasetDescription').value;
        const category = document.getElementById('editDatasetCategory').value;
        const status = document.getElementById('editDatasetStatus').value;
        const reference = document.getElementById('editDatasetReference').value;

        if (!name || !category) {
            onUtil(() => {
                thread(() => {
                    new UTIL.Toast().ok('Name and Category are required!', 'Validation', 'warning');
                });
            });
            return;
        }

        try {
            const response = await fetch(`/api/v1/dataset/${datasetId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ name, description, category, status, reference })
            });

            if (!response.ok) throw new Error('Failed to update dataset');

            // Close modal and reload details
            bootstrap.Modal.getInstance(document.getElementById('editDatasetModal')).hide();
            loadDatasetDetails();

            onUtil(() => {
                thread(() => {
                    new UTIL.Toast().ok('Dataset updated successfully!', 'Success', 'success');
                });
            });

        } catch (err) {
            console.error('Error updating dataset', err);
            onUtil(() => {
                thread(() => {
                    new UTIL.Toast().ok('Failed to update dataset', 'Error', 'error');
                });
            });
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function () {
        loadDatasetDetails();

        // Add variable button
        const addBtn = document.getElementById('addVariableBtn');
        if (addBtn) {
            addBtn.addEventListener('click', showAddVariableForm);
        }

        // Save variable button
        document.getElementById('saveVariableBtn').addEventListener('click', saveVariable);

        // Data page size
        document.getElementById('dataPageSize').addEventListener('change', function () {
            dataPageLimit = parseInt(this.value);
            currentDataPage = 1;
            loadDataPreview();
        });

        // Data pagination
        document.getElementById('dataPrevBtn').addEventListener('click', function () {
            if (currentDataPage > 1) {
                currentDataPage--;
                loadDataPreview();
            }
        });

        document.getElementById('dataNextBtn').addEventListener('click', function () {
            currentDataPage++;
            loadDataPreview();
        });

        // Patients pagination
        document.getElementById('patientsPrevBtn').addEventListener('click', function () {
            if (currentPatientsPage > 1) {
                currentPatientsPage--;
                loadPatients();
            }
        });

        document.getElementById('patientsNextBtn').addEventListener('click', function () {
            currentPatientsPage++;
            loadPatients();
        });
    });
</script>
{% endblock %}