{% extends 'admin_base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="px-2">
            <h2 class="mb-0 mt-2" style="color: var(--text-primary, #e5e7eb);">
                <i class="bi bi-upload me-2"></i>Import Data
            </h2>
            <p class="text-muted mb-0">Import data entries for <strong id="datasetNameHeader">Dataset</strong></p>
        </div>
        <a href="/dashboard/datasets/view/{{ datasetId }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back to Dataset
        </a>
    </div>

    <!-- Wizard Steps Indicator -->
    <div class="wizard-steps mb-4">
        <div class="wizard-step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Upload File</div>
        </div>
        <div class="wizard-connector"></div>
        <div class="wizard-step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Map Columns</div>
        </div>
        <div class="wizard-connector"></div>
        <div class="wizard-step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Preview</div>
        </div>
        <div class="wizard-connector"></div>
        <div class="wizard-step" data-step="4">
            <div class="step-number">4</div>
            <div class="step-label">Import</div>
        </div>
    </div>

    <!-- Wizard Content -->
    <div class="card" style="background-color: var(--card-bg, #111827); border: 1px solid var(--card-border, #374151);">
        <div class="card-body p-4">

            <!-- Step 1: Upload -->
            <div class="wizard-pane active" id="step1">
                <h4 class="mb-3" style="color: var(--text-primary, #e5e7eb);">
                    <i class="bi bi-cloud-upload me-2"></i>Upload Your File
                </h4>
                <p class="text-muted mb-4">
                    Upload a CSV or Excel file containing your data. The file should include patient identifiers
                    (name or reference) and values for each variable. Max file size: 10MB.
                </p>

                <!-- Download Template Section -->
                <div class="template-download mb-4 p-3"
                    style="background-color: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-success mb-1"><i class="bi bi-file-earmark-excel me-2"></i>Need a template?
                            </h6>
                            <p class="text-muted small mb-0">Download a pre-formatted Excel template with all dataset
                                variables</p>
                        </div>
                        <a href="/api/v1/dataset/{{ datasetId }}/template" class="btn btn-success"
                            id="downloadTemplateBtn">
                            <i class="bi bi-download me-1"></i> Download Template
                        </a>
                    </div>
                </div>

                <div class="dropzone-area" id="dropzone">
                    <div class="dropzone-content">
                        <i class="bi bi-file-earmark-spreadsheet dropzone-icon"></i>
                        <h5>Drag & Drop your file here</h5>
                        <p class="text-muted">or click to browse</p>
                        <p class="small text-muted">Supports: CSV, XLSX, XLS</p>
                    </div>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>

                <!-- Upload Progress -->
                <div class="upload-progress mt-3" style="display: none;">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="uploadFileName" class="text-muted">uploading...</span>
                        <span id="uploadPercent" class="text-primary">0%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" id="uploadProgressBar" role="progressbar"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- File Info -->
                <div class="file-info mt-3" style="display: none;">
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <div>
                            <strong id="uploadedFileName">file.csv</strong> uploaded successfully
                            <span class="text-muted ms-2" id="uploadedFileSize"></span>
                        </div>
                    </div>
                </div>

                <!-- Dataset Variables Info -->
                <div class="mt-4">
                    <h6 class="text-muted mb-2">Dataset Variables</h6>
                    <div id="datasetVariables" class="d-flex flex-wrap gap-2">
                        <span class="badge bg-secondary">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Step 2: Column Mapping -->
            <div class="wizard-pane" id="step2">
                <h4 class="mb-3" style="color: var(--text-primary, #e5e7eb);">
                    <i class="bi bi-diagram-3 me-2"></i>Map Columns
                </h4>
                <p class="text-muted mb-4">
                    Map your file columns to patient identifier and dataset variables.
                </p>

                <!-- Patient Identifier Section -->
                <div class="mapping-section mb-4 p-3"
                    style="background-color: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <h6 class="text-primary mb-3"><i class="bi bi-person me-2"></i>Patient Identifier</h6>
                    <div class="row" id="patientMappingContainer">
                        <!-- Patient mapping will be populated dynamically -->
                    </div>
                </div>

                <!-- Variable Mapping Section -->
                <div class="mapping-section mb-4">
                    <h6 class="text-muted mb-3"><i class="bi bi-list-ul me-2"></i>Variables</h6>
                    <div class="row" id="variableMappingContainer">
                        <!-- Variable mapping will be populated dynamically -->
                    </div>
                </div>

                <div class="sample-preview mt-4">
                    <h6 class="text-muted mb-2">Sample Data Preview (First 5 rows)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-dark" id="sampleDataTable">
                            <thead id="sampleDataHead"></thead>
                            <tbody id="sampleDataBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Step 3: Preview & Duplicates -->
            <div class="wizard-pane" id="step3">
                <h4 class="mb-3" style="color: var(--text-primary, #e5e7eb);">
                    <i class="bi bi-search me-2"></i>Preview & Review
                </h4>

                <!-- Stats Cards -->
                <div class="row mb-4" id="previewStats">
                    <div class="col-md-3">
                        <div class="stat-card bg-primary bg-opacity-10 border-primary">
                            <i class="bi bi-file-earmark-text"></i>
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total Rows</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-success bg-opacity-10 border-success">
                            <i class="bi bi-plus-circle"></i>
                            <div class="stat-value" id="statNew">0</div>
                            <div class="stat-label">New Entries</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-warning bg-opacity-10 border-warning">
                            <i class="bi bi-files"></i>
                            <div class="stat-value" id="statDuplicates">0</div>
                            <div class="stat-label">Updates</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-danger bg-opacity-10 border-danger">
                            <i class="bi bi-exclamation-circle"></i>
                            <div class="stat-value" id="statErrors">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>
                </div>

                <!-- Errors Section -->
                <div class="errors-section mb-4" id="errorsSection" style="display: none;">
                    <h6 class="text-danger mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>Issues Found
                    </h6>
                    <div class="errors-list" id="errorsList">
                        <!-- Errors will be listed here -->
                    </div>
                </div>

                <!-- Preview Table -->
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="previewTable"
                        style="background-color: var(--table-bg, #0f172a); color: var(--text-primary, #e5e7eb);">
                        <thead id="previewTableHead"></thead>
                        <tbody id="previewTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Step 4: Import Execution -->
            <div class="wizard-pane" id="step4">
                <div class="text-center py-4" id="importPending">
                    <i class="bi bi-rocket-takeoff" style="font-size: 4rem; color: var(--primary-color, #3b82f6);"></i>
                    <h4 class="mt-3" style="color: var(--text-primary, #e5e7eb);">Ready to Import</h4>
                    <p class="text-muted">Click the button below to start importing data entries.</p>
                    <button class="btn btn-primary btn-lg" id="startImportBtn">
                        <i class="bi bi-play-fill me-2"></i>Start Import
                    </button>
                </div>

                <div class="import-progress py-4" id="importProgress" style="display: none;">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        </div>
                        <h4 style="color: var(--text-primary, #e5e7eb);">Importing Data...</h4>
                        <p class="text-muted" id="importStatus">Processing row 0 of 0</p>
                    </div>

                    <div class="progress mb-4" style="height: 12px;">
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                            id="importProgressBar" role="progressbar" style="width: 0%"></div>
                    </div>

                    <div class="row" id="importLiveStats">
                        <div class="col-3 text-center">
                            <div class="stat-value text-success" id="liveImported">0</div>
                            <div class="stat-label">Imported</div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="stat-value text-info" id="liveUpdated">0</div>
                            <div class="stat-label">Updated</div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="stat-value text-warning" id="liveSkipped">0</div>
                            <div class="stat-label">Skipped</div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="stat-value text-danger" id="liveFailed">0</div>
                            <div class="stat-label">Failed</div>
                        </div>
                    </div>
                </div>

                <div class="import-complete py-4 text-center" id="importComplete" style="display: none;">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                    <h3 class="mt-3" style="color: var(--text-primary, #e5e7eb);">Import Complete!</h3>
                    <p class="text-muted" id="importSummary"></p>

                    <div id="failedDownload" class="mt-3" style="display: none;">
                        <a href="#" id="downloadFailedBtn" class="btn btn-outline-warning">
                            <i class="bi bi-download me-2"></i>Download Failed Rows
                        </a>
                    </div>

                    <div class="mt-4">
                        <a href="/dashboard/datasets/view/{{ datasetId }}" class="btn btn-primary">
                            <i class="bi bi-database me-2"></i>View Dataset
                        </a>
                        <button class="btn btn-outline-secondary ms-2" onclick="location.reload()">
                            <i class="bi bi-arrow-repeat me-2"></i>Import More
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="wizard-nav mt-4 pt-3 border-top" style="border-color: var(--card-border, #374151) !important;">
                <button class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
                    <i class="bi bi-chevron-left me-1"></i> Previous
                </button>
                <button class="btn btn-primary ms-auto" id="nextBtn" disabled>
                    Next <i class="bi bi-chevron-right ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/datasets/data-import.css' %}">
{% endblock %}

{% block js %}
<script nonce="{{ nonce }}">
    const CSRF_TOKEN = '{{ csrf_token }}';
    const DATASET_ID = {{ datasetId }};
    const DATASET_NAME = '{{ datasetName|default:"Dataset" }}';
</script>
<script src="{% static 'js/datasets/data-import.js' %}"></script>
{% endblock %}