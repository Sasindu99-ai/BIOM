{% extends 'admin_base.html' %}
{% load static %}
{% load files %}
{% load util %}

{% block content %}
{% if forPopup %}
<div class="p-3">
{% else %}
<div class="container-fluid">
{% endif %}
	<div class="row">
		<div class="col-12">
			{% if not forPopup %}
			<div class="card mt-3">
				<div class="card-header" style="background-color: #0b1220; border-bottom: 1px solid #374151; color: #e5e7eb;">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<h3 class="mb-1 fw-bold">Add Patients</h3>
							<p class="text-muted mb-0 small">
								Add single or multiple patients at once. Use the <i class="bi bi-plus-circle"></i> button to add more rows or <i class="bi bi-trash"></i> to remove unsaved rows.
							</p>
						</div>
					</div>
				</div>
				<div class="card-body" style="background-color: #111827;">
      {% endif %}
					<form id="addPatientForm">
						<div id="addPatientsContainer">
							<!-- Patient rows will be added here -->
						</div>
						
						<div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top" style="border-color: #374151 !important;">
							<button type="button" class="btn btn-outline-success" id="addRowBtn">
								<i class="bi bi-plus-circle me-1"></i> Add Row
							</button>
							<div class="d-flex gap-2">
								{% if forPopup %}
								<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
									<i class="bi bi-x-circle me-1"></i> Cancel
								</button>
								{% else %}
<!--								<a href="{% url 'dashboard/patients' %}" class="btn btn-outline-secondary">-->
<!--									<i class="bi bi-x-circle me-1"></i> Cancel-->
<!--								</a>-->
								{% endif %}
								<button type="submit" class="btn btn-success" id="saveAllBtn">
									<i class="bi bi-save me-1"></i> Save All
								</button>
							</div>
						</div>
					</form>
      {% if not forPopup %}
				</div>
			</div>
      {% endif %}
		</div>
	</div>
</div>
{% endblock %}

{% block css %}
<style>
.patient-add-row {
  display: grid;
  grid-template-columns: 80px 0.7fr 0.7fr 0.5fr 0.4fr 1.5fr 80px;
  gap: 0.5rem;
  padding: 0.5rem;
  margin-bottom: 0.5rem;
  border-radius: 8px;
  background-color: #0b1220;
  border: 1px solid #1f2937;
  align-items: center;
}

.patient-add-row input,
.patient-add-row select,
.patient-add-row textarea {
  background-color: #111827;
  border: 1px solid #374151;
  color: #e5e7eb;
  padding: 0.4rem 0.5rem;
  border-radius: 6px;
  font-size: 0.9rem;
}

.patient-add-row select option {
  background-color: #1f2937 !important;
  color: #e5e7eb !important;
  padding: 0.5rem;
}

.patient-add-row select:focus option {
  background-color: #374151 !important;
}

.patient-add-row input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1) brightness(2);
  cursor: pointer;
  padding: 2px;
}

.patient-add-row input[type="date"]::-webkit-inner-spin-button,
.patient-add-row input[type="date"]::-webkit-clear-button {
  filter: invert(1) brightness(2);
}

.patient-add-row input:focus,
.patient-add-row select:focus,
.patient-add-row textarea:focus {
  background-color: #111827;
  border-color: #60a5fa;
  color: #e5e7eb;
  outline: none;
}

.patient-add-row .remove-btn, .patient-add-row .save-btn {
  background: transparent;
  border: 1px solid #ef4444;
  color: #ef4444;
  padding: 0.4rem;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
}

.patient-add-row .save-btn {
  border-color: #10b981;
  color: #10b981;
}

.patient-add-row .remove-btn:hover {
  background-color: #ef4444;
  color: #fff;
}

.patient-add-row .save-btn:hover {
  background-color: #10b981;
  color: #fff;
}

.patient-id-display {
  font-weight: 600;
  color: #60a5fa;
  padding: 0.4rem;
  background-color: #1e3a5f;
  border-radius: 6px;
  text-align: center;
  font-size: 0.85rem;
}

@media (max-width: 1200px) {
  .patient-add-row {
    grid-template-columns: 80px 1fr 80px 80px;
    gap: 0.5rem;
  }
  
  .patient-add-row > div:nth-child(n+2):nth-child(-n+6) {
    grid-column: 2;
  }
}
</style>
{% endblock %}

{% block js %}
<script nonce="{{ nonce }}">
(function() {
let rowCounter = 0;

function createPatientRow(data = null) {
  rowCounter++;
  const rowDiv = document.createElement('div');
  rowDiv.className = 'patient-add-row';
  rowDiv.setAttribute('data-row-id', rowCounter);
  
  const saved = data && data.id ? true : false;
  
  rowDiv.innerHTML = `
    ${saved ? 
      `<div class="patient-id-display">#${data.id}</div>` :
      `<div></div>`
    }
    <input type="text" name="firstName" class="form-control" placeholder="First name" value="${data ? (data.firstName || '') : ''}" ${saved ? 'readonly' : ''}>
    <input type="text" name="lastName" class="form-control" placeholder="Last name" value="${data ? (data.lastName || '') : ''}" ${saved ? 'readonly' : ''}>
    <input type="date" name="dateOfBirth" class="form-control" value="${data && data.dateOfBirth ? data.dateOfBirth : ''}" ${saved ? 'readonly' : ''}>
    <select name="gender" class="form-select" ${saved ? 'disabled' : ''}>
      <option value="">Gender</option>
      {% for g in genders %}
      <option value="{{ g.name }}" ${data && data.gender === '{{ g.name }}' ? 'selected' : ''}>{{ g.label }}</option>
      {% endfor %}
    </select>
    <textarea name="notes" class="form-control" rows="1" placeholder="Notes..." ${saved ? 'readonly' : ''}>${data ? (data.notes || '') : ''}</textarea>
    ${!saved ? 
      `<div class="d-flex gap-2">
        <button type="button" class="save-btn" data-action="save" data-row-id="${rowCounter}">
          <i class="bi bi-check-lg"></i>
        </button>
        <button type="button" class="remove-btn" data-action="remove" data-row-id="${rowCounter}">
          <i class="bi bi-trash"></i>
        </button>
      </div>` :
      `<div></div>`
    }
  `;
  
  // Attach event listeners to buttons
  if (!saved) {
    const saveBtn = rowDiv.querySelector('[data-action="save"]');
    const removeBtn = rowDiv.querySelector('[data-action="remove"]');
    
    if (saveBtn) {
      saveBtn.addEventListener('click', function() {
        const rowId = this.getAttribute('data-row-id');
        saveRow(parseInt(rowId));
      });
    }
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        const rowId = this.getAttribute('data-row-id');
        removeRow(parseInt(rowId));
      });
    }
  }
  
  return rowDiv;
}

function addRow() {
  const container = document.getElementById('addPatientsContainer');
  const newRow = createPatientRow();
  container.appendChild(newRow);
  
  // Focus on firstName in the new row
  const firstNameInput = newRow.querySelector('input[name="firstName"]');
  if (firstNameInput) {
    firstNameInput.focus();
  }
  
  return newRow;
}

function removeRow(rowId) {
  const row = document.querySelector(`[data-row-id="${rowId}"]`);
  if (row) {
    row.remove();
  }
}

async function saveRow(rowId) {
  const row = document.querySelector(`[data-row-id="${rowId}"]`);
  if (!row) return;
  
  // Check if already saved
  const idDisplay = row.querySelector('.patient-id-display');
  if (idDisplay) return;
  
  // Get the save button
  const saveBtn = row.querySelector('.save-btn');
  if (!saveBtn) return;
  
  const originalHtml = saveBtn.innerHTML;
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" style="width: 1rem; height: 1rem;"></span>';
  
  try {
    // Collect patient data from this row
    const inputs = row.querySelectorAll('input, select, textarea');
    const patientData = {};
    
    inputs.forEach(input => {
      if (!input.disabled && input.name && input.value) {
        patientData[input.name] = input.value;
      }
    });
    
    // Validate
    if (!patientData.firstName && !patientData.lastName) {
      alert('Please enter at least a first name or last name');
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalHtml;
      return;
    }
    
    // Send to server
    const response = await fetch('/api/v1/patient/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify(patientData)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // Success - update the row to show the ID
      const patient = Array.isArray(result) ? result[0] : result;
      updateRowWithSavedData(row, patient);
    } else {
      throw new Error(result.message || 'Failed to save patient');
    }
    
  } catch (error) {
    console.error('Error saving patient:', error);
    alert('Error: ' + error.message);
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalHtml;
  }
}

function updateRowWithSavedData(row, patientData) {
  // Make all inputs readonly
  const inputs = row.querySelectorAll('input, select, textarea');
  inputs.forEach(input => {
    input.readOnly = true;
    input.disabled = true;
  });
  
  // Add ID display at the start
  const firstCell = row.firstElementChild;
  firstCell.innerHTML = `<div class="patient-id-display">#${patientData.id}</div>`;
  
  // Remove save and remove buttons
  const lastCell = row.lastElementChild;
  lastCell.innerHTML = `<div></div>`;
  
  // Add success styling
  row.style.borderColor = '#10b981';
  row.style.opacity = '0.8';
}

function initAddPatientForm() {
  // Add initial row
  addRow();
  
  // Setup form submission
  document.getElementById('addPatientForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const saveBtn = document.getElementById('saveAllBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
    
    try {
      // Collect all unsaved patient data
      const rows = document.querySelectorAll('.patient-add-row');
      const patients = [];
      const unsavedRows = [];
      
      rows.forEach(row => {
        // Skip already saved rows
        const idDisplay = row.querySelector('.patient-id-display');
        if (idDisplay) return;
        
        const inputs = row.querySelectorAll('input, select, textarea');
        const patientData = {};
        
        inputs.forEach(input => {
          if (!input.disabled && input.name) {
            patientData[input.name] = input.value;
          }
        });
        
        // Only add if at least firstName or lastName is provided
        if (patientData.firstName || patientData.lastName) {
          patients.push(patientData);
          unsavedRows.push(row);
        }
      });
      
      if (patients.length === 0) {
        throw new Error('Please add at least one patient with a name');
      }
      
      // Send data to server
      const response = await fetch('/api/v1/patient/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(patients)
      });
      
      const result = await response.json();
      
      if (response.ok) {
        // Update all saved rows with their IDs (match by order with unsavedRows)
        const savedPatients = Array.isArray(result) ? result : [result];
        
        savedPatients.forEach((patient, idx) => {
          if (unsavedRows[idx]) {
            updateRowWithSavedData(unsavedRows[idx], patient);
          }
        });
        
        // Show success message
        const count = savedPatients.length;
        alert(`Successfully created ${count} patient(s)!`);
      } else {
        throw new Error(result.message || 'Failed to save patients');
      }
      
    } catch (error) {
      console.error('Error saving patients:', error);
      alert('Error: ' + error.message);
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalText;
    }
  });
  
  // Setup add row button
  document.getElementById('addRowBtn').addEventListener('click', addRow);
  
  // Setup keyboard shortcut (Ctrl+N) to add new row
  document.addEventListener('keydown', function(e) {
    // Check if Ctrl+N (or Cmd+N on Mac) is pressed
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      addRow();
    }
  });
}

// Auto-initialize on page load (for full page view)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initAddPatientForm);
} else {
  initAddPatientForm();
}
})();
</script>
{% endblock %}