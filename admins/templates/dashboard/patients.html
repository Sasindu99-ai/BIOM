{% extends 'admin_base.html' %}
{% load static %}
{% load files %}
{% load util %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Statistics Cards Row -->
      <div class="row mt-3 mb-2">
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card h-100 border-0 shadow-sm"
            style="background-color: var(--card-bg, #111827); border: 1px solid var(--card-border, #374151) !important;">
            <div class="card-body">
              <div class="d-flex align-items-start justify-content-between">
                <div>
                  <h6 class="text-muted mb-1 small">Total Patients</h6>
                  <h3 class="mb-0 fw-bold" id="totalPatients" style="color: var(--text-primary, #e5e7eb);">—</h3>
                </div>
                <i class="bi bi-people-fill text-primary fs-1 opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card h-100 border-0 shadow-sm"
            style="background-color: var(--card-bg, #111827); border: 1px solid var(--card-border, #374151) !important;">
            <div class="card-body">
              <div class="d-flex align-items-start justify-content-between">
                <div>
                  <h6 class="text-muted mb-1 small">Average Age</h6>
                  <h3 class="mb-0 fw-bold" id="avgAge" style="color: var(--text-primary, #e5e7eb);">—</h3>
                </div>
                <i class="bi bi-hourglass-split text-success fs-1 opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card h-100 border-0 shadow-sm"
            style="background-color: var(--card-bg, #111827); border: 1px solid var(--card-border, #374151) !important;">
            <div class="card-body">
              <div class="d-flex align-items-start justify-content-between">
                <div>
                  <h6 class="text-muted mb-1 small">Male / Female</h6>
                  <h3 class="mb-0 fw-bold" id="genderRatio" style="color: var(--text-primary, #e5e7eb);">— / —</h3>
                </div>
                <i class="bi bi-gender-ambiguous text-info fs-1 opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card h-100 border-0 shadow-sm"
            style="background-color: var(--card-bg, #111827); border: 1px solid var(--card-border, #374151) !important;">
            <div class="card-body">
              <div class="d-flex align-items-start justify-content-between">
                <div>
                  <h6 class="text-muted mb-1 small">This Month</h6>
                  <h3 class="mb-0 fw-bold" id="thisMonth" style="color: var(--text-primary, #e5e7eb);">—</h3>
                </div>
                <i class="bi bi-calendar-plus text-warning fs-1 opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Patients Card -->
      <div class="card">
        <div class="card-header"
          style="background-color: var(--card-header-bg, #0b1220); border-bottom: 1px solid var(--card-border, #374151); color: var(--text-primary, #e5e7eb);">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-1 fw-bold">Patients</h3>
              <p class="text-muted mb-0 small">
                Manage patient records. Search, filter and browse patients efficiently.
              </p>
            </div>
            {% if canAdd %}
            <div class="d-flex align-items-center gap-3">
              <!-- Button Group 1: Single Patient -->
              <div class="btn-group" role="group">
                <button id="addSinglePatientBtn" class="btn btn-success" title="Add a single patient">
                  <i class="bi bi-person-plus me-1"></i> Add Patient
                </button>
                <a href="{% url 'dashboard/patients/create' %}" target="_blank" class="btn btn-success"
                  title="Open in new tab" style="padding: 0.375rem 0.75rem;">
                  <i class="bi bi-box-arrow-up-right"></i>
                </a>
              </div>

              <!-- Button Group 2: Multiple Patients -->
              <div class="btn-group" role="group">
                <button id="addMultiplePatientsBtn" class="btn btn-success" title="Add multiple patients">
                  <i class="bi bi-people me-1"></i> Add Multiple
                </button>
                <a href="{% url 'dashboard/patients/add' %}" target="_blank" class="btn btn-success"
                  title="Open in new tab" style="padding: 0.375rem 0.75rem;">
                  <i class="bi bi-box-arrow-up-right"></i>
                </a>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Filter Bar -->
        <div class="card-body p-0" style="position: relative;">
          <div id="filterBar" class="p-3 mb-0"
            style="background-color: var(--bg-tertiary, #071025); border-bottom: 1px solid var(--border-secondary, #1f2937);">
            <div class="row g-2">
              <div class="col-md-3">
                <div class="input-group">
                  <input type="search" id="searchInput" class="form-control" placeholder="Search by name..."
                    style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);">
                  <button type="button" class="btn btn-outline-light"
                    style="border-color: var(--border-hover, #4b5563); color: var(--text-primary, #e5e7eb);">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>

              <div class="col-md-2">
                <select id="sortSelect" class="form-select"
                  style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);">
                  <option value="created_at:desc">Newest First</option>
                  <option value="created_at:asc">Oldest First</option>
                  <option value="name:asc">Name (A-Z)</option>
                  <option value="name:desc">Name (Z-A)</option>
                  <option value="age:asc">Age (Low-High)</option>
                  <option value="age:desc">Age (High-Low)</option>
                </select>
              </div>

              <div class="col-md-2">
                <select id="genderFilter" class="form-select"
                  style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);">
                  <option value="">All genders</option>
                  {% for g in genders %}
                  <option value="{{ g.name }}">{{ g.label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-2">
                <input id="ageFilter" type="number" class="form-control"
                  style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);"
                  placeholder="Age" min="0" max="150">
              </div>

              <div class="col-md-2">
                <input id="dateOfBirth" type="date" class="form-control"
                  style="background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);"
                  placeholder="Date of Birth">
              </div>

              <div class="col-md-1 d-flex gap-2">
                <button id="resetFilters" class="btn btn-outline-secondary flex-grow-1" title="Reset filters">
                  <i class="bi bi-arrow-counterclockwise"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Patients List -->
          <div id="patientsContainer" class="p-3">
            <!-- Patient cards will be injected here -->
          </div>

          <!-- Loading indicator -->
          <div id="loadingIndicator" class="text-center p-3"
            style="display: none; color: var(--text-primary, #e5e7eb);">
            <div class="spinner-border text-light" role="status"></div>
            <span class="ms-2">Loading patients...</span>
          </div>

          <!-- Empty state -->
          <div id="emptyState" class="text-center p-5" style="display: none; color: var(--text-secondary, #9ca3af);">
            <i class="bi bi-person-x fs-1"></i>
            <p class="mt-3 mb-0">No patients found</p>
            <p class="small text-muted">Try adjusting your filters or add a new patient</p>
          </div>

          <!-- Pagination Controls -->
          <div id="paginationContainer" class="d-flex justify-content-between align-items-center p-3 border-top"
            style="border-color: var(--border-secondary, #1f2937) !important; display: none;">
            <div class="text-muted small" id="paginationInfo">
              Showing <span id="showingFrom">0</span>-<span id="showingTo">0</span> of <span id="totalCount">0</span>
            </div>
            <nav aria-label="Page navigation">
              <ul class="pagination mb-0" id="paginationNumbers">
                <!-- Page numbers will be injected here -->
              </ul>
            </nav>
            <div class="d-flex gap-2 align-items-center">
              <label class="small text-muted mb-0 me-2">Per page:</label>
              <select id="pageSizeSelect" class="form-select form-select-sm"
                style="width: auto; background-color: var(--input-bg, #0b1220); border-color: var(--input-border, #374151); color: var(--input-text, #e5e7eb);">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Patient Modal -->
<div class="modal fade" id="addPatientModal" tabindex="-1" aria-labelledby="addPatientModalLabel" aria-hidden="true"
  style="background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 95%;">
    <div class="modal-content"
      style="background-color: var(--card-bg, #111827); border: 1px solid var(--card-border, #374151);">
      <div class="modal-header"
        style="background-color: var(--card-header-bg, #0b1220); border-bottom: 1px solid var(--card-border, #374151);">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="modal-title mb-1" id="addPatientModalLabel" style="color: var(--text-primary, #e5e7eb);">
              <i class="bi bi-person-plus me-2"></i>Add Patients
            </h5>
            <p class="text-muted mb-0 small">
              Add single or multiple patients at once. Use the <i class="bi bi-plus-circle"></i> button to add more rows
              or <i class="bi bi-trash"></i> to remove unsaved rows.
            </p>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="color: var(--text-primary, #e5e7eb); max-height: 70vh; overflow-y: auto;"
        id="modalContent">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block css %}
{{ block.super }}
<style>
  /* Filter bar styling */
  #filterBar .form-select,
  #filterBar .form-control {
    min-width: 120px;
  }

  #filterBar .form-select option {
    background-color: var(--input-bg, #1f2937) !important;
    color: var(--input-text, #e5e7eb) !important;
  }

  #filterBar .form-control[type="date"]::-webkit-calendar-picker-indicator,
  #filterBar .form-control[type="number"]::-webkit-inner-spin-button {
    filter: invert(1) brightness(2);
    cursor: pointer;
  }

  /* Patient card styling - Professional Limitless Dark Theme */
  .patient-card {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.625rem 0.75rem;
    border-radius: 8px;
    background-color: #1e1e2e;
    border: 1px solid #2a2a3a;
    color: #e4e4e7;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 0.375rem;
    opacity: 0;
    animation: fadeIn 0.3s ease-out forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .patient-card:hover {
    background-color: #252535;
    border-color: #3b82f6;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15), 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .patient-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    flex-shrink: 0;
    box-shadow: 0 1px 4px rgba(102, 126, 234, 0.25);
  }

  .patient-info {
    flex: 1;
    min-width: 0;
  }

  .patient-name {
    font-weight: 600;
    font-size: 0.875rem;
    color: #f4f4f5;
    margin-bottom: 0.0625rem;
  }

  .patient-id {
    font-size: 0.75rem;
    color: #a1a1aa;
  }

  .patient-details {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .patient-detail {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.8rem;
    color: #d4d4d8;
  }

  .patient-detail i {
    color: #a1a1aa;
    font-size: 0.85rem;
  }

  .gender-male {
    color: #60a5fa !important;
  }

  .gender-female {
    color: #f472b6 !important;
  }

  .gender-other {
    color: #a1a1aa !important;
  }

  /* Patient Action Buttons Container */
  .patient-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-left: auto;
  }

  .patient-edit-btn,
  .patient-delete-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 1.1rem;
    text-decoration: none;
  }

  .patient-edit-btn {
    color: #60a5fa;
  }

  .patient-edit-btn:hover {
    background-color: rgba(96, 165, 250, 0.1);
    color: #3b82f6;
  }

  .patient-delete-btn {
    color: #f87171;
  }

  .patient-delete-btn:hover {
    background-color: rgba(248, 113, 113, 0.1);
    color: #fca5a5;
  }

  .patient-delete-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  /* Skeleton loader */
  .skeleton-card {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.625rem 0.75rem;
    border-radius: 8px;
    background-color: #1e1e2e;
    border: 1px solid #2a2a3a;
    margin-bottom: 0.375rem;
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  .skeleton-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(90deg, #2a2a3a 25%, #34344a 50%, #2a2a3a 75%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
  }

  .skeleton-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .skeleton-line {
    height: 8px;
    background: linear-gradient(90deg, #2a2a3a 25%, #34344a 50%, #2a2a3a 75%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
    border-radius: 4px;
  }

  .skeleton-line.wide {
    width: 70%;
  }

  .skeleton-line.medium {
    width: 50%;
  }

  .skeleton-line.short {
    width: 30%;
  }

  @keyframes shimmer {
    0% {
      background-position: 200% 0;
    }

    100% {
      background-position: -200% 0;
    }
  }

  @keyframes pulse {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.7;
    }
  }

  /* Pagination styling */
  .pagination {
    gap: 0.25rem;
  }

  .pagination .page-link {
    background-color: var(--card-bg, #111827);
    border-color: var(--border-primary, #374151);
    color: var(--text-primary, #e5e7eb);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
  }

  .pagination .page-link:hover {
    background-color: var(--bg-secondary, #1f2937);
    border-color: var(--border-hover, #4b5563);
    color: var(--text-primary, #fff);
  }

  .pagination .page-item.active .page-link {
    background-color: #3b82f6;
    border-color: #3b82f6;
    color: #fff;
  }

  .pagination .page-item.disabled .page-link {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .patient-card {
      flex-direction: column;
      align-items: flex-start;
    }

    .patient-details {
      width: 100%;
      gap: 0.75rem;
    }

    .patient-delete-btn {
      align-self: flex-end;
    }
  }

  /* Light Theme Overrides */
  [data-color-theme="light"] .patient-card {
    background-color: #ffffff;
    border-color: #e5e7eb;
    color: #1f2937;
  }

  [data-color-theme="light"] .patient-card:hover {
    background-color: #f9fafb;
    border-color: #3b82f6;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12), 0 4px 8px rgba(0, 0, 0, 0.05);
  }

  [data-color-theme="light"] .patient-name {
    color: #111827;
  }

  [data-color-theme="light"] .patient-id {
    color: #6b7280;
  }

  [data-color-theme="light"] .patient-detail {
    color: #374151;
  }

  [data-color-theme="light"] .patient-detail i {
    color: #9ca3af;
  }

  [data-color-theme="light"] .skeleton-card {
    background-color: #f9fafb;
    border-color: #e5e7eb;
  }

  [data-color-theme="light"] .skeleton-avatar,
  [data-color-theme="light"] .skeleton-line {
    background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
    background-size: 200% 100%;
  }
</style>
{% endblock %}

{% block js %}
<script nonce="{{ nonce }}">
  let currentPage = 1;
  let isLoading = false;
  let currentSearch = '';
  let filterGender = '';
  let dateOfBirth = '';
  let ageFilter = '';
  let pageSize = 20;
  let totalPatients = 0;
  let stats = { total: 0, avgAge: 0, male: 0, female: 0, thisMonth: 0 };
  let sortField = 'created_at';
  let sortDirection = 'desc';

  function formatDateShort(dateString) {
    if (!dateString) return '—';
    const d = new Date(dateString);
    return d.toLocaleDateString();
  }

  function calculateAge(dobStr) {
    if (!dobStr) return '—';
    const dob = new Date(dobStr);
    if (isNaN(dob.getTime())) return '—';
    const diff = Date.now() - dob.getTime();
    const ageDt = new Date(diff);
    return Math.abs(ageDt.getUTCFullYear() - 1970);
  }

  // Skeleton loader helper
  function showSkeletons(count = 5) {
    const container = document.getElementById('patientsContainer');
    container.innerHTML = '';
    for (let i = 0; i < count; i++) {
      const skeleton = `
        <div class="skeleton-card" style="animation-delay: ${i * 50}ms">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-content">
            <div class="skeleton-line wide"></div>
            <div class="skeleton-line medium"></div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', skeleton);
    }
  }

  function createPatientCard(p) {
    const first = (p.firstName || '').trim();
    const last = (p.lastName || '').trim();
    const fullName = `${first} ${last}`.trim() || 'Unknown';
    const initials = ((first.charAt(0) || '') + (last.charAt(0) || '')).toUpperCase() || '?';
    const pid = p.pid || p.id || '—';
    const dob = p.dateOfBirth || p.dob || '';
    const dobLabel = dob ? new Date(dob).toLocaleDateString() : '—';
    const age = p.age || calculateAge(dob);
    const genderRaw = (p.gender || '').toString().toLowerCase();
    let genderClass = 'gender-other';
    let genderLabel = 'Other';
    let genderIcon = 'bi-gender-ambiguous';
    if (genderRaw === 'male' || genderRaw === 'm') {
      genderClass = 'gender-male';
      genderIcon = 'bi-gender-male';
      genderLabel = 'Male';
    }
    if (genderRaw === 'female' || genderRaw === 'f') {
      genderClass = 'gender-female';
      genderIcon = 'bi-gender-female';
      genderLabel = 'Female';
    }
    const created = p.createdAt ? new Date(p.createdAt).toLocaleDateString() : '';
    const hasStudies = p.userStudiesCount > 0;
    const canDelete = {% if canDelete %} true{% else %} false{% endif %};
  const canEdit = {% if canEdit %} true{% else %} false{% endif %};

  // Check if patient has a profile photo
  const hasPhoto = p.photo && p.photo.trim() !== '';
  const photoUrl = hasPhoto ? p.photo : '';

  // Avatar display: photo or initials
  let avatarHTML = '';
  if (hasPhoto) {
    avatarHTML = `<div class="patient-avatar" style="padding: 0; overflow: hidden;">
          <img src="${photoUrl}" alt="${fullName}" style="width: 100%; height: 100%; object-fit: cover;">
        </div>`;
  } else {
    avatarHTML = `<div class="patient-avatar">${initials}</div>`;
  }

  // Action buttons
  let actionButtons = '';
  if (canEdit || canDelete) {
    actionButtons += '<div class="patient-actions">';

    if (canEdit) {
      actionButtons += `<a href="/dashboard/patients/edit/${pid}" class="patient-edit-btn" title="Edit patient">
        <i class="bi bi-pencil"></i>
      </a>`;
    }

    if (canDelete) {
      actionButtons += `<button type="button" class="patient-delete-btn" onclick="deletePatient(${pid})" ${hasStudies ? 'disabled title="Cannot delete patient with studies"' : 'title="Delete patient"'}>
        <i class="bi bi-trash"></i>
      </button>`;
    }

    actionButtons += '</div>';
  }

  return `
  <div class="patient-card">
    ${avatarHTML}
    
    <div class="patient-info">
      <div class="patient-name">${fullName}</div>
      <div class="patient-id">#${pid}</div>
    </div>

    <div class="patient-details">
      <div class="patient-detail">
        <i class="bi ${genderIcon} ${genderClass}"></i>
        <span class="${genderClass}">${genderLabel}</span>
      </div>

      <div class="patient-detail">
        <i class="bi bi-calendar-event"></i>
        <span>${dobLabel}</span>
      </div>

      <div class="patient-detail">
        <i class="bi bi-hourglass-split"></i>
        <span>${age !== '—' ? age + ' yrs' : '—'}</span>
      </div>

      <div class="patient-detail">
        <i class="bi bi-clock-history"></i>
        <span>${created}</span>
      </div>
    </div>
    
    ${actionButtons}
  </div>
  `;
}

  function updateStats(data) {
    if (data && data.stats) {
      stats = data.stats;
      document.getElementById('totalPatients').textContent = stats.total || 0;
      document.getElementById('avgAge').textContent = stats.avgAge ? Math.round(stats.avgAge) + ' yrs' : '—';
      document.getElementById('genderRatio').textContent = `${stats.male || 0} / ${stats.female || 0}`;
      document.getElementById('thisMonth').textContent = stats.thisMonth || 0;
    }
  }

  function updatePagination(pagination) {
    if (!pagination) return;

    const container = document.getElementById('paginationContainer');
    const numbersContainer = document.getElementById('paginationNumbers');
    const total = pagination.total || 0;
    const current = pagination.page || 1;
    const limit = pagination.limit || pageSize;
    const totalPages = Math.ceil(total / limit);

    if (total === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'flex';

    // Update info
    const from = (current - 1) * limit + 1;
    const to = Math.min(current * limit, total);
    document.getElementById('showingFrom').textContent = from;
    document.getElementById('showingTo').textContent = to;
    document.getElementById('totalCount').textContent = total;

    // Build pagination
    let paginationHTML = '';

    // Previous button
    paginationHTML += `
    <li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="changePage(${current - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
      </a>
    </li>
  `;

    // Page numbers
    const maxButtons = 7;
    let startPage = Math.max(1, current - Math.floor(maxButtons / 2));
    let endPage = Math.min(totalPages, startPage + maxButtons - 1);

    if (endPage - startPage < maxButtons - 1) {
      startPage = Math.max(1, endPage - maxButtons + 1);
    }

    if (startPage > 1) {
      paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1); return false;">1</a></li>`;
      if (startPage > 2) {
        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      paginationHTML += `
      <li class="page-item ${i === current ? 'active' : ''}">
        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
      </li>
    `;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      }
      paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a></li>`;
    }

    // Next button
    paginationHTML += `
    <li class="page-item ${current === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="changePage(${current + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </li>
  `;

    numbersContainer.innerHTML = paginationHTML;
  }

  function changePage(page) {
    if (page < 1 || isLoading) return;
    currentPage = page;
    loadPatients(page, false);
  }

  async function loadPatients(page = 1, append = false) {
    if (isLoading) return;
    isLoading = true;

    // Show skeleton loaders on first load or filter change
    if (!append && page === 1) {
      showSkeletons(pageSize > 10 ? 10 : pageSize);
    } else {
      document.getElementById('loadingIndicator').style.display = 'block';
    }
    document.getElementById('emptyState').style.display = 'none';

    try {
      const params = {
        pagination: { page: page, limit: pageSize },
        sortField: sortField,
        sortDirection: sortDirection
      };
      if (currentSearch) params.search = currentSearch;
      if (filterGender) params.gender = filterGender;
      if (dateOfBirth) params.dateOfBirth = dateOfBirth;
      if (ageFilter) params.age = parseInt(ageFilter);

      const response = await fetch('/api/v1/patient/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(params)
      });

      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();
      const patients = Array.isArray(data) ? data : (data.results || data.data || []);

      if (!append) {
        document.getElementById('patientsContainer').innerHTML = '';
      }

      if (patients.length === 0 && page === 1) {
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('paginationContainer').style.display = 'none';
      } else {
        patients.forEach(p => {
          document.getElementById('patientsContainer').insertAdjacentHTML('beforeend', createPatientCard(p));
        });

        // Update pagination if data includes pagination info
        if (data.pagination) {
          updatePagination(data.pagination);
        }

        // Update stats if available
        updateStats(data);
      }

      currentPage = page;
    } catch (err) {
      console.error('Error fetching patients', err);
      if (!append) {
        document.getElementById('patientsContainer').innerHTML = '<div class="text-center text-muted p-4">Error loading patients</div>';
      }
    } finally {
      isLoading = false;
      document.getElementById('loadingIndicator').style.display = 'none';
    }
  }

  function setupFilters() {
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const genderSelect = document.getElementById('genderFilter');
    const dobInput = document.getElementById('dateOfBirth');
    const ageInput = document.getElementById('ageFilter');
    const resetBtn = document.getElementById('resetFilters');
    const pageSizeSelect = document.getElementById('pageSizeSelect');

    let debounceTimer;
    function triggerReload() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        currentPage = 1;
        currentSearch = searchInput.value.trim();
        filterGender = genderSelect.value;
        dateOfBirth = dobInput.value;
        ageFilter = ageInput.value;
        loadPatients(1, false);
      }, 500);
    }

    // Sort change handler
    sortSelect.addEventListener('change', function () {
      const [field, direction] = this.value.split(':');
      sortField = field;
      sortDirection = direction;
      currentPage = 1;
      loadPatients(1, false);
    });

    // Age and DOB mutual exclusivity
    ageInput.addEventListener('input', function () {
      if (this.value) {
        dobInput.value = '';
      }
      triggerReload();
    });

    dobInput.addEventListener('change', function () {
      if (this.value) {
        ageInput.value = '';
      }
      triggerReload();
    });

    searchInput.addEventListener('input', triggerReload);
    genderSelect.addEventListener('change', triggerReload);

    resetBtn.addEventListener('click', function () {
      searchInput.value = '';
      sortSelect.value = 'created_at:desc';
      genderSelect.value = '';
      dobInput.value = '';
      ageInput.value = '';
      sortField = 'created_at';
      sortDirection = 'desc';
      triggerReload();
    });

    pageSizeSelect.addEventListener('change', function () {
      pageSize = parseInt(this.value);
      currentPage = 1;
      loadPatients(1, false);
    });
  }

  async function deletePatient(patientId) {
    onUtil(() => {
      thread(() => {
        new UTIL.Toast().okCancel(
          'This action cannot be undone!',
          'Delete Patient',
          'warning',
          'Yes, delete it!',
          'No, cancel please!',
          'btn btn-danger',
          'btn btn-secondary'
        ).then(function (result) {
          if (result.value) {
            performDelete(patientId);
          }
        });
      });
    });
  }

  async function performDelete(patientId) {
    try {
      const response = await fetch(`/api/v1/patient/${patientId}`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      });

      const result = await response.json();

      if (response.ok) {
        onUtil(() => {
          thread(() => {
            new UTIL.Toast().ok('Patient deleted successfully', 'Success', 'success');
          });
        });

        // Reload current page
        loadPatients(currentPage, false);
      } else {
        onUtil(() => {
          thread(() => {
            new UTIL.Toast().ok(result.message || 'Failed to delete patient', 'Error', 'error');
          });
        });
      }
    } catch (error) {
      console.error('Error deleting patient:', error);
      onUtil(() => {
        thread(() => {
          new UTIL.Toast().ok('Error: ' + error.message, 'Error', 'error');
        });
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Helper function to get CSRF token from cookie
    function getCsrfToken() {
      const name = 'csrftoken';
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Single Patient Button (Popup)
    document.getElementById('addSinglePatientBtn')?.addEventListener('click', async function () {
      const modal = new bootstrap.Modal(document.getElementById('addPatientModal'));
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3 text-muted">Loading...</p></div>';
      modal.show();

      try {
        const csrfToken = getCsrfToken();
        const response = await fetch('{% url "dashboard/patients/create" %}', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
          },
          credentials: 'same-origin',
          body: new URLSearchParams({ forPopup: 'true' })
        });

        if (!response.ok) throw new Error('Failed to load form');

        const html = await response.text();
        modalContent.innerHTML = html;

        // Re-execute scripts
        const scripts = modalContent.querySelectorAll('script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) newScript.src = oldScript.src;
          else newScript.textContent = oldScript.textContent;
          if (oldScript.nonce) newScript.nonce = oldScript.nonce;
          oldScript.parentNode.removeChild(oldScript);
          modalContent.appendChild(newScript);
        });
      } catch (error) {
        modalContent.innerHTML = '<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle me-2"></i>Error loading form. Please try again.</div>';
        console.error('Error loading single patient form:', error);
        onUtil(() => { thread(() => { new UTIL.Toast().ok('Error: ' + error.message, 'Error', 'error'); }); });
      }
    });

    // Multiple Patients Button (Popup)
    document.getElementById('addMultiplePatientsBtn')?.addEventListener('click', async function () {
      const modal = new bootstrap.Modal(document.getElementById('addPatientModal'));
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3 text-muted">Loading...</p></div>';
      modal.show();

      try {
        const csrfToken = getCsrfToken();
        const response = await fetch('{% url "dashboard/patients/add" %}', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
          },
          credentials: 'same-origin',
          body: new URLSearchParams({ forPopup: 'true' })
        });

        if (!response.ok) throw new Error('Failed to load form');

        const html = await response.text();
        modalContent.innerHTML = html;

        // Re-execute scripts
        const scripts = modalContent.querySelectorAll('script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) newScript.src = oldScript.src;
          else newScript.textContent = oldScript.textContent;
          if (oldScript.nonce) newScript.nonce = oldScript.nonce;
          oldScript.parentNode.removeChild(oldScript);
          modalContent.appendChild(newScript);
        });
      } catch (error) {
        modalContent.innerHTML = '<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle me-2"></i>Error loading form. Please try again.</div>';
        console.error('Error loading multiple patients form:', error);
        onUtil(() => { thread(() => { new UTIL.Toast().ok('Error: ' + error.message, 'Error', 'error'); }); });
      }
    });
    setupFilters();
    loadPatients(1, false);
  });
</script>
{% endblock %}